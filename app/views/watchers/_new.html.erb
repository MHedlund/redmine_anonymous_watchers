<h3 class="title"><%= l(:permission_add_issue_watchers) %></h3>

<style type="text/css">
  input#watcher_mails { width: 100%; }
</style>

<% if (Redmine::VERSION::ARRAY <=> [2, 1, 0]) > 0 %>
  <% form = form_tag({:controller => 'watchers',
                :action => (watched ? 'create' : 'append'),
                :object_type => watched.class.name.underscore,
                :object_id => watched},
               :remote => true,
               :method => :post,
               :id => 'new-watcher-form') do %>

    <p><%= label_tag 'user_search', l(:label_user_search) %><%= text_field_tag 'user_search', nil %></p>
    <%= javascript_tag "observeSearchfield('user_search', 'users_for_watcher', '#{ escape_javascript url_for(:controller => 'watchers',
                   :action => 'autocomplete_for_user',
                   :object_type => watched.class.name.underscore,
                   :object_id => watched) }')" %>

    <div id="users_for_watcher">
      <%= principals_check_box_tags 'watcher[user_ids][]', (watched ? watched.addable_watcher_users : User.active.all(:limit => 100)) %>
    </div>

    <p><%= label_tag 'watcher[mails]', l(:label_optional_watcher_mails) %><br><%= text_field_tag 'watcher[mails]', nil %></p>

    <p class="buttons">
      <%= submit_tag l(:button_add), :name => nil, :onclick => "hideModal(this);" %>
      <%= submit_tag l(:button_cancel), :name => nil, :onclick => "hideModal(this);", :type => 'button' %>
    </p>
  <% end %>
  <%= form %>
<% else %>
  <% form = form_remote_tag :url => {:controller => 'watchers',
                              :action => (watched ? 'create' : 'append'),
                              :object_type => watched.class.name.underscore,
                              :object_id => watched},
                       :method => :post,
                       :html => {:id => 'new-watcher-form'} do %>

    <p><%= label_tag 'user_search', l(:label_user_search) %><%= text_field_tag 'user_search', nil %></p>
    <%= observe_field(:user_search,
                 :frequency => 0.5,
                 :update => :users_for_watcher,
                 :method => :get,
                 :before => '$("user_search").addClassName("ajax-loading")',
                 :complete => '$("user_search").removeClassName("ajax-loading")',
                 :url => {
                   :controller => 'watchers',
                   :action => 'autocomplete_for_user',
                   :object_type => watched.class.name.underscore,
                   :object_id => watched},
                 :with => 'q') %>

    <div id="users_for_watcher">
      <%= principals_check_box_tags 'watcher[user_ids][]', (watched ? watched.addable_watcher_users : User.active.all(:limit => 100)) %>
    </div>

    <p><%= label_tag 'watcher[mails]', l(:label_optional_watcher_mails) %><br><%= text_field_tag 'watcher[mails]', nil %></p>

    <p class="buttons">
      <%= submit_tag l(:button_add), :name => nil, :onclick => "hideModal(this);" %>
      <%= submit_tag l(:button_cancel), :name => nil, :onclick => "hideModal(this);", :type => 'button' %>
    </p>
  <% end %>
  <%= form if (Redmine::VERSION::ARRAY <=> [2, 0, 0]) > 0 %>
<% end %>
